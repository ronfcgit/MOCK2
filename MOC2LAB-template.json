{  
    "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{  
       "location":{  
          "type":"string"
       },
       "networkInterfaceName":{  
          "type":"string"
       },
       "networkSecurityGroupName":{  
          "type":"string"
       },
       "networkSecurityGroupRules":{  
          "type":"array"
       },
       "subnetName":{  
          "type":"string"
       },
       "virtualNetworkName":{  
          "type":"string"
       },
       "addressPrefixes":{  
          "type":"array"
       },
       "subnets":{  
          "type":"array"
       },
       "publicIpAddressName":{  
          "type":"string"
       },
       "publicIpAddressType":{  
          "type":"string"
       },
       "publicIpAddressSku":{  
          "type":"string"
       },
       "virtualMachineName":{  
          "type":"string"
       },
       "virtualMachineRG":{  
          "type":"string"
       },
       "osDiskType":{  
          "type":"string"
       },
       "virtualMachineSize":{  
          "type":"string"
       },
       "adminUsername":{  
          "type":"string"
       },
       "adminPassword":{  
          "type":"secureString"
       },
       "autoShutdownStatus":{  
          "type":"string"
       },
       "autoShutdownTime":{  
          "type":"string"
       },
       "autoShutdownTimeZone":{  
          "type":"string"
       },
       "autoShutdownNotificationStatus":{  
          "type":"string"
       },
       "autoShutdownNotificationLocale":{  
          "type":"string"
       }
    },
    "variables":{  
       "nsgId":"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]",
       "vnetId":"[resourceId(resourceGroup().name,'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
       "subnetRef":"[concat(variables('vnetId'), '/subnets/', parameters('subnetName'))]"
    },
    "resources":[  
       {  
          "name":"[parameters('networkInterfaceName')]",
          "type":"Microsoft.Network/networkInterfaces",
          "apiVersion":"2018-04-01",
          "location":"[parameters('location')]",
          "dependsOn":[  
             "[concat('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]",
             "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]",
             "[concat('Microsoft.Network/publicIpAddresses/', parameters('publicIpAddressName'))]"
          ],
          "properties":{  
             "ipConfigurations":[  
                {  
                   "name":"ipconfig1",
                   "properties":{  
                      "subnet":{  
                         "id":"[variables('subnetRef')]"
                      },
                      "privateIPAllocationMethod":"Dynamic",
                      "publicIpAddress":{  
                         "id":"[resourceId(resourceGroup().name, 'Microsoft.Network/publicIpAddresses', parameters('publicIpAddressName'))]"
                      }
                   }
                }
             ],
             "networkSecurityGroup":{  
                "id":"[variables('nsgId')]"
             }
          },
          "tags":{  
             "MOC2-NIC":"5"
          }
       },
       {  
          "name":"[parameters('networkSecurityGroupName')]",
          "type":"Microsoft.Network/networkSecurityGroups",
          "apiVersion":"2018-08-01",
          "location":"[parameters('location')]",
          "properties":{  
             "securityRules":"[parameters('networkSecurityGroupRules')]"
          },
          "tags":{  
             "MOC2-NSG":"4"
          }
       },
       {  
          "name":"[parameters('virtualNetworkName')]",
          "type":"Microsoft.Network/virtualNetworks",
          "apiVersion":"2018-08-01",
          "location":"[parameters('location')]",
          "properties":{  
             "addressSpace":{  
                "addressPrefixes":"[parameters('addressPrefixes')]"
             },
             "subnets":"[parameters('subnets')]"
          },
          "tags":{  
             "MOC2-VNIC":"2"
          }
       },
       {  
          "name":"[parameters('publicIpAddressName')]",
          "type":"Microsoft.Network/publicIpAddresses",
          "apiVersion":"2018-08-01",
          "location":"[parameters('location')]",
          "properties":{  
             "publicIpAllocationMethod":"[parameters('publicIpAddressType')]"
          },
          "sku":{  
             "name":"[parameters('publicIpAddressSku')]"
          },
          "tags":{  
             "MOC2-PUBIP":"3"
          }
       },
       {  
          "name":"[parameters('virtualMachineName')]",
          "type":"Microsoft.Compute/virtualMachines",
          "apiVersion":"2018-06-01",
          "location":"[parameters('location')]",
          "dependsOn":[  
             "[concat('Microsoft.Network/networkInterfaces/', parameters('networkInterfaceName'))]"
          ],
          "properties":{  
             "hardwareProfile":{  
                "vmSize":"[parameters('virtualMachineSize')]"
             },
             "storageProfile":{  
                "osDisk":{  
                   "createOption":"fromImage",
                   "managedDisk":{  
                      "storageAccountType":"[parameters('osDiskType')]"
                   }
                },
                "imageReference":{  
                   "publisher":"MicrosoftWindowsServer",
                   "offer":"WindowsServer",
                   "sku":"2012-R2-Datacenter",
                   "version":"latest"
                }
             },
             "networkProfile":{  
                "networkInterfaces":[  
                   {  
                      "id":"[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                   }
                ]
             },
             "osProfile":{  
                "computerName":"[parameters('virtualMachineName')]",
                "adminUsername":"[parameters('adminUsername')]",
                "adminPassword":"[parameters('adminPassword')]",
                "windowsConfiguration":{  
                   "enableAutomaticUpdates":true,
                   "provisionVmAgent":true
                }
             }
          },
          "tags":{  
             "MOC2_VM":"1"
          }
       },
       {  
          "name":"[concat('shutdown-computevm-', parameters('virtualMachineName'))]",
          "type":"Microsoft.DevTestLab/schedules",
          "apiVersion":"2017-04-26-preview",
          "location":"[parameters('location')]",
          "dependsOn":[  
             "[concat('Microsoft.Compute/virtualMachines/', parameters('virtualMachineName'))]"
          ],
          "properties":{  
             "status":"[parameters('autoShutdownStatus')]",
             "taskType":"ComputeVmShutdownTask",
             "dailyRecurrence":{  
                "time":"[parameters('autoShutdownTime')]"
             },
             "timeZoneId":"[parameters('autoShutdownTimeZone')]",
             "targetResourceId":"[resourceId('Microsoft.Compute/virtualMachines', parameters('virtualMachineName'))]",
             "notificationSettings":{  
                "status":"[parameters('autoShutdownNotificationStatus')]",
                "notificationLocale":"[parameters('autoShutdownNotificationLocale')]",
                "timeInMinutes":"30"
             }
          },
          "tags":{  
 
          }
       },
       {  
          "type":"Microsoft.Compute/virtualMachines/extensions",
          "apiVersion":"2018-06-01",
          "name":"[concat(parameters('virtualMachineName'),'/BGInfo')]",
          "location":"[resourceGroup().location]",
          "dependsOn":[  
             "[concat('Microsoft.Compute/virtualMachines/', parameters('virtualMachineName'))]"
          ],
          "properties":{  
             "publisher":"Microsoft.Compute",
             "type":"BGInfo",
             "typeHandlerVersion":"2.1",
             "autoUpgradeMinorVersion":true,
             "settings":{  
                "Properties":[  
 
                ]
             }
          }
       }
    ],
    "outputs":{  
       "adminUsername":{  
          "type":"string",
          "value":"[parameters('adminUsername')]"
       }
    }
 }
